<!DOCTYPE html>
<html>
<head>
    <title>Security Questions Test for User 999</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; }
        input { padding: 8px; margin: 5px 0; width: 300px; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Security Questions Test for User 999</h1>
    
    <h2>Step 1: Initial Login (Get Security Question)</h2>
    <button onclick="testInitialLogin()">Test Initial Login for User 999</button>
    <div id="initialResult"></div>
    
    <h2>Step 2: Answer Security Question</h2>
    <div id="questionDisplay" style="display:none;">
        <div id="questionText"></div>
        <input type="text" id="answerInput" placeholder="Enter your answer">
        <button onclick="testSecurityAnswer()">Submit Answer</button>
    </div>
    <div id="answerResult"></div>
    
    <h2>Test the 4 Questions Directly</h2>
    <button onclick="testQuestion1()">Q1: Tiny red 1987 Turbo _____ (Answer: sprint)</button><br>
    <button onclick="testQuestion2()">Q2: Mister _____ (Answer: levi/levy)</button><br>
    <button onclick="testQuestion3()">Q3: Twins: _______ (Answer: wallace)</button><br>
    <button onclick="testQuestion4()">Q4: Elementary school: _______ (Answer: parkway)</button><br>
    
    <div id="directTestResult"></div>

    <script>
        let currentQuestionId = null;
        
        async function testInitialLogin() {
            const result = document.getElementById('initialResult');
            result.innerHTML = 'Testing initial login for user 999...';
            
            try {
                const response = await fetch('https://ekklokrukxmqlahtonnc.supabase.co/rest/v1/rpc/authenticate_user_with_security_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVra2xva3J1a3htcWxhaHRvbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAwNzMxOTQsImV4cCI6MjA1NTY0OTE5NH0.LFyaAQyBb2l6rxdUAXpDQVZnR4gHDNrVZH0YudbjP3k'
                    },
                    body: JSON.stringify({
                        p_identifier: '999',
                        p_password: '2750GroveAvenue'
                    })
                });
                
                const data = await response.json();
                console.log('Initial login response:', data);
                
                if (data && data.length > 0) {
                    const loginResult = data[0];
                    if (loginResult.requires_security_question) {
                        currentQuestionId = loginResult.security_question_id;
                        document.getElementById('questionText').innerText = 'Question: ' + loginResult.security_question_text;
                        document.getElementById('questionDisplay').style.display = 'block';
                        
                        result.className = 'result success';
                        result.innerHTML = `
                            <h3>✅ Security Question Retrieved!</h3>
                            <p><strong>Question ID:</strong> ${loginResult.security_question_id}</p>
                            <p><strong>Question:</strong> ${loginResult.security_question_text}</p>
                            <p>Now answer the question above!</p>
                        `;
                    } else {
                        result.className = 'result error';
                        result.innerHTML = '<h3>❌ Expected security question but got: ' + JSON.stringify(loginResult) + '</h3>';
                    }
                } else {
                    result.className = 'result error';
                    result.innerHTML = '<h3>❌ No data returned</h3>';
                }
            } catch (e) {
                console.error('Error:', e);
                result.className = 'result error';
                result.innerHTML = '<h3>❌ Error: ' + e.message + '</h3>';
            }
        }
        
        async function testSecurityAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();
            const result = document.getElementById('answerResult');
            
            if (!answer || !currentQuestionId) {
                result.innerHTML = 'Please enter an answer and get a question first.';
                return;
            }
            
            result.innerHTML = 'Testing security answer...';
            
            try {
                const response = await fetch('https://ekklokrukxmqlahtonnc.supabase.co/rest/v1/rpc/authenticate_user_with_security_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVra2xva3J1a3htcWxhaHRvbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAwNzMxOTQsImV4cCI6MjA1NTY0OTE5NH0.LFyaAQyBb2l6rxdUAXpDQVZnR4gHDNrVZH0YudbjP3k'
                    },
                    body: JSON.stringify({
                        p_identifier: '999',
                        p_password: '2750GroveAvenue',
                        p_question_id: currentQuestionId,
                        p_security_answer: answer
                    })
                });
                
                const data = await response.json();
                console.log('Security answer response:', data);
                
                if (data && data.length > 0) {
                    const loginResult = data[0];
                    if (loginResult.success) {
                        result.className = 'result success';
                        result.innerHTML = `
                            <h3>✅ LOGIN SUCCESSFUL!</h3>
                            <p><strong>Message:</strong> ${loginResult.message}</p>
                            <p><strong>Account ID:</strong> ${loginResult.account_id}</p>
                            <p><strong>Session Token:</strong> ${loginResult.session_token ? 'Generated' : 'None'}</p>
                        `;
                    } else {
                        result.className = 'result error';
                        result.innerHTML = `
                            <h3>❌ LOGIN FAILED</h3>
                            <p><strong>Message:</strong> ${loginResult.message}</p>
                        `;
                    }
                } else {
                    result.className = 'result error';
                    result.innerHTML = '<h3>❌ No data returned</h3>';
                }
            } catch (e) {
                console.error('Error:', e);
                result.className = 'result error';
                result.innerHTML = '<h3>❌ Error: ' + e.message + '</h3>';
            }
        }
        
        async function testDirectQuestion(questionNum, answer) {
            const result = document.getElementById('directTestResult');
            result.innerHTML = `Testing Q${questionNum} with answer: ${answer}...`;
            
            try {
                const response = await fetch('https://ekklokrukxmqlahtonnc.supabase.co/rest/v1/rpc/verify_security_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVra2xva3J1a3htcWxhaHRvbm5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAwNzMxOTQsImV4cCI6MjA1NTY0OTE5NH0.LFyaAQyBb2l6rxdUAXpDQVZnR4gHDNrVZH0YudbjP3k'
                    },
                    body: JSON.stringify({
                        p_question_id: questionNum,
                        p_answer: answer
                    })
                });
                
                const data = await response.json();
                console.log(`Q${questionNum} test response:`, data);
                
                if (data === true) {
                    result.className = 'result success';
                    result.innerHTML = `✅ Q${questionNum} CORRECT: "${answer}" is the right answer!`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `❌ Q${questionNum} WRONG: "${answer}" is not correct.`;
                }
            } catch (e) {
                console.error('Error:', e);
                result.className = 'result error';
                result.innerHTML = `❌ Error testing Q${questionNum}: ${e.message}`;
            }
        }
        
        function testQuestion1() { testDirectQuestion(1, 'sprint'); }
        function testQuestion2() { testDirectQuestion(2, 'levi'); }
        function testQuestion3() { testDirectQuestion(3, 'wallace'); }
        function testQuestion4() { testDirectQuestion(4, 'parkway'); }
    </script>
</body>
</html>